name: Deploy to Production

# Ensure only one run per workflow+branch; cancel older runs when a new one starts
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [ master ]

jobs:
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true
          working-directory: src

      - name: Install Ruby dependencies
        working-directory: src
        run: bundle install

      - name: Cache setup
        uses: actions/cache@v4
        with:
          path: |
            src/vendor/bundle
            ~/.dotnet
          key: ${{ runner.os }}-build-${{ hashFiles('src/Gemfile.lock') }}

  generate:
    name: Generate Data Files
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Run data generators
        shell: pwsh
        run: |
          ./tools/build.ps1 --IncludeUpdates

      - name: Upload generated data
        uses: actions/upload-artifact@v4
        with:
          name: generated-data
          path: |
            src/_data/**
            src/extensions/**
            src/categories/**
            src/files/**
          retention-days: 7

  build:
    name: Build Jekyll Site
    runs-on: ubuntu-latest
    needs: generate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true
          working-directory: src

      - name: Install Ruby dependencies
        working-directory: src
        run: bundle install

      - name: Download generated data
        uses: actions/download-artifact@v4
        with:
          name: generated-data
          path: src/

      - name: Build Jekyll site
        working-directory: src
        env:
          JEKYLL_ENV: production
        run: bundle exec jekyll build

      - name: Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-build
          path: src/_site/
          include-hidden-files: true
          retention-days: 1

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout deployment scripts
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github/deploy
          sparse-checkout-cone-mode: false

      - name: Download site artifact
        uses: actions/download-artifact@v4
        with:
          name: site-build
          path: _site/

      - name: Generate deployment key
        id: deploy_key
        run: |
          set -euo pipefail
          # Generate a one-time deploy key and immediately mask it in logs
          DEPLOY_KEY=$(openssl rand -hex 32)
          echo "::add-mask::${DEPLOY_KEY}"
          # Export as step output without printing the key elsewhere
          echo "deploy_key=${DEPLOY_KEY}" >> "$GITHUB_OUTPUT"
          # Write key file for upload
          printf '%s' "${DEPLOY_KEY}" > .deploy.key
          # Do not echo the key value to logs
          echo "üîë Generated unique deployment key (masked)"

      - name: Create deployment package
        run: |
          echo "üì¶ Creating site.zip from _site directory..."
          cd _site
          zip -r -q ../site.zip .
          cd ..
          
          ZIP_SIZE=$(stat -f%z site.zip 2>/dev/null || stat -c%s site.zip)
          ZIP_SIZE_MB=$(echo "scale=2; $ZIP_SIZE / 1024 / 1024" | bc)
          echo "‚úÖ Created site.zip (${ZIP_SIZE_MB} MB)"
          
          FILE_COUNT=$(unzip -l site.zip | tail -1 | awk '{print $2}')
          echo "üìä Package contains ${FILE_COUNT} files"

      - name: Upload deployment package via SFTP
        env:
          SFTP_HOST: ${{ secrets.FTP_SERVER }}
          SFTP_USER: ${{ secrets.FTP_USERNAME }}
          SFTP_PASS: ${{ secrets.FTP_PASSWORD }}
          SFTP_PORT: ${{ secrets.FTP_PORT }}
          SFTP_DIR: ${{ secrets.FTP_SERVER_DIR }}
        run: |
          sudo apt-get update -y
          sudo apt-get install -y lftp
          
          PORT="${SFTP_PORT:-22}"
          DEPLOY_DIR="${SFTP_DIR}/.deploy"
          
          echo "=========================================="
          echo "üì§ Uploading deployment package"
          echo "=========================================="
          echo "Destination: ${DEPLOY_DIR}"
          echo ""
          
          lftp -u "$SFTP_USER","$SFTP_PASS" -p "$PORT" sftp://"$SFTP_HOST" <<EOF
          set sftp:auto-confirm yes
          set ssl:verify-certificate no
          set net:timeout 60
          set net:max-retries 3
          mkdir -p "$DEPLOY_DIR"
          cd "$DEPLOY_DIR"
          put site.zip
          put .deploy.key
          put .github/deploy/deploy.php
          chmod 644 site.zip
          chmod 644 .deploy.key
          chmod 644 deploy.php
          bye
          EOF
          
          echo ""
          echo "‚úÖ Upload complete!"

      - name: Trigger deployment via HTTP
        env:
          WEB_SERVER: ${{ vars.WEB_SERVER }}
          DEPLOY_KEY: ${{ steps.deploy_key.outputs.deploy_key }}
        run: |
          echo "=========================================="
          echo "üöÄ Triggering deployment"
          echo "=========================================="
          # Build the URL but do not print it (key is masked)
          DEPLOY_URL="${WEB_SERVER}/.deploy/deploy.php?key=${DEPLOY_KEY}"
          echo "Calling deployment script... (URL is masked)"
          echo ""
          HTTP_CODE=$(curl -s -w "%{http_code}" -o response.json --max-time 300 "$DEPLOY_URL")
          
          echo "HTTP Status: ${HTTP_CODE}"
          echo ""
          
          if [ ! -s response.json ]; then
            echo "‚ùå Empty response from deployment script!"
            echo "Possible causes:"
            echo "  - Script not found (404)"
            echo "  - PHP fatal error"
            echo "  - Server timeout"
            exit 1
          fi
          
          echo "Response:"
          cat response.json | jq '.' 2>/dev/null || cat response.json
          echo ""
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Deployment failed with HTTP ${HTTP_CODE}"
            exit 1
          fi
          
          SUCCESS=$(cat response.json | jq -r '.success')
          
          if [ "$SUCCESS" = "true" ]; then
            FILES_DEPLOYED=$(cat response.json | jq -r '.files_deployed')
            FILES_DELETED=$(cat response.json | jq -r '.files_deleted')
            DURATION=$(cat response.json | jq -r '.duration_seconds')
            
            echo "=========================================="
            echo "‚úÖ Deployment successful!"
            echo "=========================================="
            echo "üì§ Files deployed: ${FILES_DEPLOYED}"
            echo "üóëÔ∏è  Files deleted: ${FILES_DELETED}"
            echo "‚è±Ô∏è  Duration: ${DURATION}s"
          else
            ERRORS=$(cat response.json | jq -r '.errors | join(", ")')
            echo "‚ùå Deployment failed!"
            echo "Errors: ${ERRORS}"
            exit 1
          fi

      - name: Cleanup deployment artifacts
        if: always()
        env:
          SFTP_HOST: ${{ secrets.FTP_SERVER }}
          SFTP_USER: ${{ secrets.FTP_USERNAME }}
          SFTP_PASS: ${{ secrets.FTP_PASSWORD }}
          SFTP_PORT: ${{ secrets.FTP_PORT }}
          SFTP_DIR: ${{ secrets.FTP_SERVER_DIR }}
        run: |
          sudo apt-get install -y sshpass
          
          PORT="${SFTP_PORT:-22}"
          DEPLOY_DIR="${SFTP_DIR}/.deploy"
          
          echo "üßπ Cleaning up deployment artifacts..."
          
          # Try removing the configured .deploy and also the user's home .deploy as a fallback
          sudo apt-get update -y
          sudo apt-get install -y lftp

          PORT="${SFTP_PORT:-22}"
          DEPLOY_DIR="${SFTP_DIR}/.deploy"

          echo "üßπ Cleaning up deployment artifacts..."

          # Use lftp to remove the deploy directory recursively if present
          lftp -u "$SFTP_USER","$SFTP_PASS" -p "$PORT" sftp://"$SFTP_HOST" <<EOF || true
          set sftp:auto-confirm yes
          set ssl:verify-certificate no
          set net:timeout 60
          set net:max-retries 3
          rm -r "$DEPLOY_DIR" || true
          rm -r "$HOME/.deploy" || true
          bye
          EOF
          
          echo "‚úÖ Cleanup complete"
          
          echo "‚úÖ Cleanup complete"
